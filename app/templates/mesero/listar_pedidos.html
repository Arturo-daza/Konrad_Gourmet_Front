{% extends "base.html" %}

{% block content %}
<div class="p-6 bg-white shadow-md rounded-lg">
    <div class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold text-gray-800">Gestión de Pedidos</h1>
        {% if session['rol'] == 'Mesero' %}
        <a href="/mesero/pedidos/crear" class="py-2 px-4 bg-indigo-600 text-white rounded hover:bg-indigo-700">
            Agregar Pedido
        </a>
        {% endif %}
    </div>


    <!-- Filtros -->
    <form method="GET" action="" class="flex space-x-4 mb-4">
        <!-- Filtro por Fecha -->
        <div>
            <label for="fecha" class="block text-sm font-medium text-gray-700">Fecha</label>
            <input type="date" name="fecha" id="fecha" value="{{ request.args.get('fecha', fecha_hoy) }}"
                class="border border-gray-300 rounded-md px-3 py-2 w-full">

        </div>

        <!-- Filtro por Estado -->
        <div>
            <label for="estado" class="block text-sm font-medium text-gray-700">Estado</label>
            <select name="estado" id="estado" class="border border-gray-300 rounded-md px-3 py-2 w-full">
                <option value="">Todos</option>
                <option value="pendiente" {% if request.args.get('estado')=='pendiente' %}selected{% endif %}>
                    Pendiente
                </option>
                <option value="preparado" {% if request.args.get('estado')=='preparado' %}selected{% endif %}>
                    Preparado
                </option>
                <option value="entregado" {% if request.args.get('estado')=='entregado' %}selected{% endif %}>
                    Entregado
                </option>
                <option value="cancelado" {% if request.args.get('estado')=='cancelado' %}selected{% endif %}>
                    Cancelado
                </option>
            </select>
        </div>

        <!-- Filtro por Mesa -->
        <div>
            <label for="mesa" class="block text-sm font-medium text-gray-700">Mesa</label>
            <input type="text" name="mesa" id="mesa" value="{{ request.args.get('mesa', '') }}"
                class="border border-gray-300 rounded-md px-3 py-2 w-full">
        </div>

        <!-- Botón Filtrar -->
        <div class="flex items-end">
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Filtrar</button>
        </div>
    </form>


    <!-- Tabla de Pedidos -->
    <table class="min-w-full border border-gray-300 bg-white shadow rounded-md">
        <thead>
            <tr class="bg-gray-100 text-center">
                <th class="py-2 px-4 border-b">ID Pedido</th>
                <th class="py-2 px-4 border-b">Mesa</th>
                <th class="py-2 px-4 border-b">Estado</th>
                <th class="py-2 px-4 border-b">Total</th>
                <th class="py-2 px-4 border-b">Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for pedido in pedidos %}
            <tr class="hover:bg-gray-50 text-center">
                <td class="py-2 px-4 border-b">{{ pedido.id_pedido }}</td>
                <td class="py-2 px-4 border-b">{{ pedido.mesa }}</td>
                <td class="py-2 px-4 border-b">{{ pedido.estado }}</td>
                <td class="py-2 px-4 border-b">${{ "{:,.2f}".format(pedido.total) }}</td>
                <td class="py-2 px-4 border-b flex justify-center space-x-2">
                    <!-- Acciones -->
                    <button class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600"
                        onclick='mostrarDetalles({{ pedido|tojson|safe }})'>Ver Detalles</button>
                    <button class="bg-indigo-500 text-white px-3 py-1 rounded hover:bg-indigo-600"
                        onclick="mostrarModalEstado({{ pedido.id_pedido }}, '{{ pedido.estado }}')">Cambiar
                        Estado</button>
                    {% if session['rol'] == 'Mesero' %}
                    <button class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600"
                        onclick="editarPedido({{ pedido.id_pedido }})">Editar</button>
                    <button class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600"
                        onclick="eliminarPedido({{ pedido.id_pedido }})">Eliminar</button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal para Detalles -->
<div id="modal-detalles" data-id-pedido=""
    class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center">
    <div class="bg-white p-6 rounded shadow-lg w-1/2">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Detalles del Pedido</h2>
        <table class="min-w-full border border-gray-300 bg-white shadow rounded-md">
            <thead>
                <tr class="bg-gray-100 text-left">
                    <th class="py-2 px-4 border-b">Plato</th>
                    <th class="py-2 px-4 border-b">Cantidad</th>
                    <th class="py-2 px-4 border-b">Precio Unitario</th>
                    <th class="py-2 px-4 border-b">Subtotal</th>
                </tr>
            </thead>
            <tbody id="detalles-body"></tbody>
        </table>
        <div class="flex justify-end mt-4 space-x-2">
            {% if session['rol'] == 'Mesero' %}
            <!-- Botón Editar Pedido -->
            <button class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" onclick="editarPedidoModal()">
                Editar Pedido
            </button>

            <!-- Botón Eliminar Pedido -->
            <button class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600" onclick="eliminarPedidoModal()">
                Eliminar Pedido
            </button>
            {% endif %}
            <button class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                onclick="cerrarModal()">Cerrar</button>

        </div>
    </div>
</div>

<!-- Modal para Cambiar Estado -->
<div id="modal-estado" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center">
    <div class="bg-white p-6 rounded shadow-lg w-1/3">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Cambiar Estado del Pedido</h2>
        <form id="form-cambiar-estado" method="POST">
            <input type="hidden" name="id_pedido" id="id-pedido">
            <label for="estado" class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
            <select name="estado" id="dropdown-estado" class="border border-gray-300 rounded-md px-3 py-2 w-full"
                required>
                <option value="">Seleccionar Estado</option>
                <option value="pendiente">Pendiente</option>
                <option value="preparado">Preparado</option>
                <option value="entregado">Entregado</option>
                <option value="cancelado">Cancelado</option>
            </select>
            <div class="flex justify-end mt-4 space-x-2">
                <button type="button" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                    onclick="cerrarModal('modal-estado')">Cancelar</button>
                <button type="submit"
                    class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">Guardar</button>
            </div>
        </form>

    </div>
</div>

<!-- Modal para Crear Pedido -->
<div id="modal-pedido" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center">
    <div class="bg-white p-6 rounded shadow-lg w-2/3">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Nuevo Pedido</h2>

        <!-- Selección de Mesa -->
        <div class="mb-4">
            <label for="mesa" class="block text-sm font-medium text-gray-700">Mesa</label>
            <input type="number" id="mesa" class="border border-gray-300 rounded-md px-3 py-2 w-full" min="1" required>
        </div>

        <!-- Lista de Platos -->
        <div id="platos-container" class="mb-4">
            <label class="block text-sm font-medium text-gray-700">Platos</label>
            <button type="button" onclick="agregarPlato()"
                class="mt-2 mb-4 bg-indigo-600 text-white px-3 py-1 rounded-md">Agregar Plato</button>

            <div class="plato flex items-center space-x-4 mb-2">
                <select name="id_plato[]" class="plato-select border border-gray-300 rounded-md shadow-sm" required>
                    <option value="">Seleccionar Plato</option>
                </select>
                <input type="number" name="cantidad[]" placeholder="Cantidad"
                    class="cantidad border border-gray-300 rounded-md shadow-sm" required>
                <button type="button" onclick="this.parentNode.remove()"
                    class="bg-red-600 text-white px-3 py-1 rounded-md">Eliminar</button>
            </div>
        </div>

        <div class="flex justify-end space-x-4">
            <button onclick="cerrarModalPedido()"
                class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancelar</button>
            <button onclick="guardarPedido()"
                class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Guardar</button>
        </div>
    </div>
</div>

<script>
    function mostrarDetalles(pedido) {
        const modal = document.getElementById("modal-detalles");
        const detallesBody = document.getElementById("detalles-body");

        // Limpiar detalles anteriores
        detallesBody.innerHTML = "";

        // Agregar detalles del pedido
        pedido.detalles.forEach(detalle => {
            const row = `
                <tr>
                    <td class="py-2 px-4 border-b">${detalle.nombre}</td>
                    <td class="py-2 px-4 border-b">${detalle.cantidad}</td>
                    <td class="py-2 px-4 border-b">$${detalle.precio_unitario.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="py-2 px-4 border-b">$${detalle.subtotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                </tr>
            `;
            detallesBody.insertAdjacentHTML("beforeend", row);
        });

        // Establecer el id-pedido en el atributo del modal
        modal.setAttribute("data-id-pedido", pedido.id_pedido);

        // Mostrar el modal
        modal.classList.remove("hidden");
    }


    function cerrarModal() {
        const modal = document.getElementById("modal-detalles");
        modal.classList.add("hidden");
    }



    function mostrarModalEstado(idPedido, estadoActual) {
        // Asignar el ID del pedido al input hidden
        document.getElementById("id-pedido").value = idPedido;

        // Seleccionar el estado actual en el dropdown
        document.getElementById("dropdown-estado").value = estadoActual;

        // Ajustar dinámicamente la acción del formulario
        const form = document.getElementById("form-cambiar-estado");
        form.action = `/chef/pedidos/${idPedido}/estado`;

        // Mostrar el modal
        const modal = document.getElementById("modal-estado");
        modal.classList.remove("hidden");
    }

    function editarPedido(idPedido) {
        // Redirigir al formulario de edición
        window.location.href = `/mesero/pedidos/${idPedido}/editar`;
    }

    function eliminarPedido(idPedido) {
        if (confirm("¿Estás seguro de que deseas eliminar este pedido?")) {
            const token = "{{ session['access_token'] }}"; // Obtener el token de la sesión
            fetch(`http://localhost:8000/api/pedidos/${idPedido}`, {



                method: "DELETE",
                headers: {
                    "Authorization": `Bearer ${token}`, // Agregar el token en la cabecera
                    "Content-Type": "application/json"
                }
            })
                .then(response => {
                    if (response.ok) {
                        alert("Pedido eliminado correctamente");
                        window.location.reload();
                    } else {
                        alert("Error al eliminar el pedido");
                    }
                })
                .catch(error => console.error("Error:", error));
        }
    }

    function editarPedidoModal() {
        const modal = document.getElementById("modal-detalles");
        const idPedido = modal.getAttribute("data-id-pedido");

        // Redirigir al formulario de edición
        window.location.href = `/mesero/pedidos/${idPedido}/editar`;
    }

    function eliminarPedidoModal() {
        const modal = document.getElementById("modal-detalles");
        const idPedido = modal.getAttribute("data-id-pedido");

        if (confirm("¿Estás seguro de que deseas eliminar este pedido?")) {
            const token = "{{ session['access_token'] }}"; // Obtener el token de la sesión
            fetch(`http://localhost:8000/api/pedidos/${idPedido}`, {
                method: "DELETE",
                headers: {
                    "Authorization": `Bearer ${token}`, // Agregar el token en la cabecera
                    "Content-Type": "application/json"
                }
            })
                .then(response => {
                    if (response.ok) {
                        alert("Pedido eliminado correctamente");
                        window.location.reload();
                    } else {
                        alert("Error al eliminar el pedido");
                    }
                })
                .catch(error => console.error("Error:", error));
        }
    }

    // Abrir modal
    function abrirModalPedido() {
        cargarPlatosPreparables();
        document.getElementById("modal-pedido").classList.remove("hidden");
    }

    // Cerrar modal
    function cerrarModalPedido() {
        document.getElementById("modal-pedido").classList.add("hidden");
    }

    // Cargar platos preparables desde la API
    function cargarPlatosPreparables() {
        fetch("http://127.0.0.1:8000/api/platos/acciones/preparables")
            .then(response => response.json())
            .then(platos => {
                const platoSelects = document.querySelectorAll(".plato-select");
                platoSelects.forEach(select => {
                    select.innerHTML = '<option value="">Seleccionar Plato</option>';
                    platos.forEach(plato => {
                        const option = document.createElement("option");
                        option.value = plato.id_plato;
                        option.textContent = `${plato.nombre} (Máx: ${plato.cantidad_preparable})`;
                        option.setAttribute("data-max", plato.cantidad_preparable);
                        select.appendChild(option);
                    });
                });
            })
            .catch(error => console.error("Error al cargar platos preparables:", error));
    }

    // Agregar un nuevo plato
    function agregarPlato() {
        const container = document.getElementById("platos-container");
        const template = `
        <div class="plato flex items-center space-x-4 mb-2">
            <select name="id_plato[]" class="plato-select border border-gray-300 rounded-md shadow-sm" required>
                <option value="">Seleccionar Plato</option>
            </select>
            <input type="number" name="cantidad[]" placeholder="Cantidad" class="cantidad border border-gray-300 rounded-md shadow-sm" required>
            <button type="button" onclick="this.parentNode.remove()" class="bg-red-600 text-white px-3 py-1 rounded-md">Eliminar</button>
        </div>
    `;
        container.insertAdjacentHTML("beforeend", template);
        cargarPlatosPreparables();
    }

    // Guardar el pedido
    function guardarPedido() {
        const mesa = document.getElementById("mesa").value;
        const platos = Array.from(document.querySelectorAll(".plato"));
        const detalles = platos.map(plato => {
            const idPlato = plato.querySelector(".plato-select").value;
            const cantidad = plato.querySelector(".cantidad").value;
            const maxCantidad = parseInt(
                plato.querySelector(".plato-select").selectedOptions[0].getAttribute("data-max")
            );

            if (cantidad > maxCantidad) {
                alert(`La cantidad ingresada para un plato excede el máximo disponible (${maxCantidad}).`);
                throw new Error("Cantidad excedida.");
            }

            return {
                id_plato: parseInt(idPlato),
                cantidad: parseInt(cantidad)
            };
        });

        const data = {
            mesa: parseInt(mesa),
            fecha: new Date().toISOString(),
            detalles: detalles
        };

        fetch("http://127.0.0.1:8000/api/pedidos", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer {{ session['access_token'] }}`
            },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (response.ok) {
                    alert("Pedido creado exitosamente.");
                    window.location.reload();
                } else {
                    alert("Error al crear el pedido.");
                }
            })
            .catch(error => console.error("Error al guardar el pedido:", error));
    }

</script>

{% endblock %}